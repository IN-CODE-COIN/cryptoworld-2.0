# Etapa 1: dependencias con Composer
FROM composer:2 AS builder
WORKDIR /app
COPY composer.json composer.lock ./
RUN composer config platform.php 8.2
RUN composer install --no-dev --no-scripts --no-progress --prefer-dist
COPY . .

# Etapa 2: PHP + Nginx + supervisord
FROM php:8.2-fpm-bullseye

WORKDIR /var/www/html

# Instalar dependencias de sistema y extensiones PHP
RUN apt-get update && apt-get install -y \
    nginx supervisor libpng-dev libonig-dev libxml2-dev zip unzip git curl \
    && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd \
    && rm -rf /var/lib/apt/lists/*

# Copiar app desde builder
COPY --from=builder /app /var/www/html

# Copiar configs de Nginx y supervisord
COPY nginx.conf /etc/nginx/sites-available/default
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Permisos
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

EXPOSE 80

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
